@model IEnumerable<Tuple<PechinchaMarket.Models.ProdutoLoja, PechinchaMarket.Models.Produto>>

@{
    ViewData["Title"] = "Edit";
    IEnumerable<Loja> lojas = ViewData["Lojas"] as IEnumerable<Loja>;
}
<link href="~/css/produto.css" rel="stylesheet" />

<a class="img-back" asp-action="Index"></a>
<h2>Editar Produto</h2>

<body class="gradiante2-secondary-color background-height">
    <div>
        <form asp-action="Edit" enctype="multipart/form-data"  class="form">
            <input type="hidden" name="produtoId" value="@Model.FirstOrDefault().Item2.Id" />
            <div class="addProduct">
            <div class="addProductLeft">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <div style="display:none" id="produtoId">
                    @Html.DisplayFor(model => model.FirstOrDefault().Item2.Id)
                </div>
                <div class="form-group">
                        <input type="text" name="name" style="display: none" value="@Model.FirstOrDefault().Item2.Name" />
                        @Html.DisplayFor(model => model.FirstOrDefault().Item2.Name)
                </div>
                <div class="form-group">
                        <input type="text" name="brand" style="display: none" value="@Model.FirstOrDefault().Item2.Brand" />
                        @Html.DisplayFor(model => model.FirstOrDefault().Item2.Brand)
                </div>
                <div class="form-group">
                    <label>Categoria: </label>
                    @Html.DisplayFor(model => model.FirstOrDefault().Item2.ProdCategoria)
                </div>
                <hr />
                    <div class="precoUnidade form-group">
                        <div class="preco">
                            <input name="price" class="form-control" id="price" onchange="changePrice()" placeholder="€" value="@Model.FirstOrDefault().Item1.Price">
                        </div>
                         €/ 
                        <div class="unidade">
                            @Html.DisplayFor(model => model.FirstOrDefault().Item2.Unidade)
                        </div>
                    </div>
                    <div>
                        <input type="checkbox" id="discounts" onchange="hasDiscount(this)" />
                        <label for="discounts">Aplicar desconto</label>
                    </div>
                    <div id="descontos" class="desconto form-group">
                       <div class="">
                            <label for="valor">Valor: </label>
                            <input name="discount" class="form-control custom-input" id="valor" onchange="changeDiscount()" />%
                       </div> 
                        <div class="duracao">
                            <label for="daterange">Selecione o intervalo de datas:</label>
                            <input name="duration" type="text" id="daterange" onclick="toggleDatepickers()" readonly="true" />

                            <input type="date" id="startDatePicker" style="display: none" onchange="handleDateChange(event)">
                            <input type="date" id="endDatePicker" style="display: none" onchange="handleDateChange(event)">
                        </div>
                        
                    </div>     
                    <div class="form-group">
                        <input type="checkbox" id="shops" onchange="hasShops(this)" />
                        <label for="shops">Personalizar desconto por loja</label>
                    </div>
            </div>
            <div class="addProductRight">
                <div class="form-group">
                        <label>Imagem: </label>
                        <img id="image_preview" src="@Url.Action("Show", "Produtos", new { id = @Model.Select(x => x.Item2.Id).FirstOrDefault()})" alt="your image" width="250px" height="250px" class="imagePlaceholder" />
                        <div class="uploadImage">
                            <label asp-for ="@Model.FirstOrDefault().Item2.Image" class="custom-file-upload">Adicionar Foto</label>
                            <input type="file" asp-for="@Model.FirstOrDefault().Item2.Image" class="image" name="file" onchange="readfile(this)" />
                            <span asp-validation-for="@Model.FirstOrDefault().Item2.Image" class="text-danger"></span>
                        </div>
                </div>
            </div>
            </div>
            <div class="bottom">
                <div id="lojas">
                    <table class="shopTable">
                        <thead>
                            <tr>
                                <th>
                                    Morada
                                </th>
                                <th>
                                    Preço
                                </th>
                                <th>
                                    Desconto
                                </th>
                                <th>
                                    Duração 
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (lojas != null)
                            {
                                @foreach (Loja l in lojas)
                                {
                                    <tr>
                                        <td>
                                            @Html.DisplayFor(modelItem => l.Address)
                                        </td>
                                        <td>
                                            @{
                                                // Preço pela morada
                                                var price = Model.Where(x => x.Item1.Loja.Address == l.Address).Select(x => x.Item1.Price).FirstOrDefault();
                                            }
                                            <input type="number" id="priceInput" name="price" class="prices custom-input" value="@price" /> €
                                        </td>
                                        <td>
                                            @{
                                                // Desconto pela morada
                                                var desconto = Model.Where(x => x.Item1.Loja.Address == l.Address).Select(x => x.Item1.Discount).FirstOrDefault();
                                            }
                                            <input type="number"  name="discount" class="discount custom-input" value="@desconto"/> %
                                        </td>
                                        <td>
                                            <input type="text" id="data" class="data" onclick="openDatepicker()" readonly="true"/>

                                            <input type="date" id="startDatePicker" style="display: none" onchange="handleDateChange(event)">
                                            <input type="date" id="endDatePicker" style="display: none" onchange="handleDateChange(event)">
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>

                <div class="form-group">
                    <input name="id" type="hidden" asp-for="@Model.FirstOrDefault().Item2.Id, " />
                    <input type="submit" value="Guardar Alterações" class="blue-button" />
                </div>
            </div>
        </form>
        </div>
</body>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        function readfile(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();

                reader.onload = function (e) {
                    $('#image_preview').attr('src', e.target.result);
                }

                reader.readAsDataURL(input.files[0]);
            }
        }

        function hasShops(input) {
            var x = document.getElementById("lojas")
            if (input.checked == true) {
                x.style.display = "block"
            } else {
                x.style.display = "none"
            }
        }

        function hasDiscount(input) {
            var x = document.getElementById("descontos")
            if (input.checked == true) {
                x.style.display = "block"
            } else {
                x.style.display = "none"
            }
        }

        function changePrice() {
            var p = document.getElementById("price");
            var ps = document.getElementsByClassName("prices")

            for (let item of ps) {
                    item.value = p.value
            }
        }

        function changeDiscount() {
            var v = document.getElementById("valor");
            var d = document.getElementsByClassName("discount")

            for (let item of d) {
                item.value = v.value
            }
        }

        function changeDate() {
            var da = document.getElementById("daterange");
            console.log(da.value)
            var dt = document.getElementsByClassName("data");
            console.log(dt) 
            for (let item of dt) {
                item.value = da.value
            }
        }

        let startDate = null;
        let endDate = null;

        function toggleDatepickers() {
            const startDatePicker = document.getElementById("startDatePicker");
            const endDatePicker = document.getElementById("endDatePicker");

            if (startDatePicker.style.display === "none") {
                startDatePicker.style.display = "block";
                endDatePicker.style.display = "block";
            } else {
                startDatePicker.style.display = "none";
                endDatePicker.style.display = "none";
            }
        }

        function handleDateChange(event) {
            const selectedDate = event.target.value;

            if (event.target.id === "startDatePicker") {
                startDate = new Date(selectedDate).toLocaleDateString('pt-BR');
            } else if (event.target.id === "endDatePicker") {
                endDate = new Date(selectedDate).toLocaleDateString('pt-BR');

                // Atualizar o valor do input para mostrar o intervalo de datas
                document.getElementById("daterange").value = startDate + " - " + endDate;

                // Esconder os inputs de data
                document.getElementById("startDatePicker").style.display = "none";
                document.getElementById("endDatePicker").style.display = "none";

                changeDate();
            }
        }

    </script>
}
